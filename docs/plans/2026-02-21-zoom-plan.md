# Zoom via Pinch/Wheel Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Add cursor-anchored zoom via Ctrl+wheel, pinch gestures, and keyboard shortcuts to the drawing canvas.

**Architecture:** Add `_zoom` state to `drawing-canvas.ts` alongside existing `_panX/_panY`. Modify the coordinate pipeline (`_getDocPoint`), compositing (`composite`), preview transforms, and selection preview to factor in zoom. Wire Ctrl+wheel for zoom input, and add keyboard shortcuts (Ctrl+=/-, Ctrl+0) in `drawing-app.ts`.

**Tech Stack:** Lit 3, TypeScript, Canvas 2D API

---

### Task 1: Add zoom state and coordinate pipeline

**Files:**
- Modify: `src/components/drawing-canvas.ts:55-63` (pan state section)
- Modify: `src/components/drawing-canvas.ts:509-516` (`_getDocPoint`)

**Step 1: Add zoom state variable**

After the pan state block (line 63), add zoom state:

```typescript
// --- Zoom state ---
private _zoom = 1;
private static readonly MIN_ZOOM = 0.1;
private static readonly MAX_ZOOM = 10;
private static readonly ZOOM_STEP = 1.1;
```

**Step 2: Update `_getDocPoint` to account for zoom**

Replace lines 509-516:

```typescript
/** Convert viewport pointer position to document coordinates */
private _getDocPoint(e: PointerEvent): Point {
  const rect = this.mainCanvas.getBoundingClientRect();
  return {
    x: (e.clientX - rect.left - this._panX) / this._zoom,
    y: (e.clientY - rect.top - this._panY) / this._zoom,
  };
}
```

**Step 3: Verify build**

Run: `cd /Users/egecan/Code/ketchup && npx tsc --noEmit`
Expected: No errors

**Step 4: Commit**

```bash
git add src/components/drawing-canvas.ts
git commit -m "feat(zoom): add zoom state and update coordinate pipeline"
```

---

### Task 2: Update composite() and preview transforms

**Files:**
- Modify: `src/components/drawing-canvas.ts:102-143` (`composite`)
- Modify: `src/components/drawing-canvas.ts:661-676` (shape preview transform)
- Modify: `src/components/drawing-canvas.ts:797-807` (selection drawing preview transform)

**Step 1: Add `scale` to `composite()`**

In `composite()`, after `displayCtx.translate(this._panX, this._panY);` (line 114), add:

```typescript
displayCtx.scale(this._zoom, this._zoom);
```

**Step 2: Add `scale` to shape preview transform**

In `_onPointerMove`, after `previewCtx.translate(this._panX, this._panY);` (line 665), add:

```typescript
previewCtx.scale(this._zoom, this._zoom);
```

**Step 3: Add `scale` to selection drawing preview transform**

In `_handleSelectPointerMove`, after `previewCtx.translate(this._panX, this._panY);` (line 805), add:

```typescript
previewCtx.scale(this._zoom, this._zoom);
```

**Step 4: Verify build**

Run: `cd /Users/egecan/Code/ketchup && npx tsc --noEmit`
Expected: No errors

**Step 5: Commit**

```bash
git add src/components/drawing-canvas.ts
git commit -m "feat(zoom): apply zoom scale to composite and preview transforms"
```

---

### Task 3: Update selection preview for zoom

**Files:**
- Modify: `src/components/drawing-canvas.ts:883-909` (`_redrawSelectionPreview`)

**Step 1: Update `_redrawSelectionPreview`**

`putImageData` ignores canvas transforms, so we need to draw lifted selection content using `drawImage` instead, and apply the zoom transform to the selection rect.

Replace `_redrawSelectionPreview()` entirely:

```typescript
private _redrawSelectionPreview() {
  const previewCtx = this.previewCanvas.getContext('2d')!;
  previewCtx.clearRect(0, 0, this._vw, this._vh);

  // Draw lifted selection image data (putImageData ignores transforms, so use drawImage)
  if (this._selectionImageData && this._selection) {
    // Create a temporary canvas from the ImageData
    const tmp = document.createElement('canvas');
    tmp.width = this._selectionImageData.width;
    tmp.height = this._selectionImageData.height;
    tmp.getContext('2d')!.putImageData(this._selectionImageData, 0, 0);

    previewCtx.save();
    previewCtx.translate(this._panX, this._panY);
    previewCtx.scale(this._zoom, this._zoom);
    previewCtx.drawImage(tmp, this._selection.x, this._selection.y);
    previewCtx.restore();
  }

  // Selection rect respects canvas transforms
  if (this._selection) {
    previewCtx.save();
    previewCtx.translate(this._panX, this._panY);
    previewCtx.scale(this._zoom, this._zoom);
    drawSelectionRect(
      previewCtx,
      this._selection.x,
      this._selection.y,
      this._selection.w,
      this._selection.h,
      this._selectionDashOffset,
    );
    previewCtx.restore();
  }
}
```

**Step 2: Verify build**

Run: `cd /Users/egecan/Code/ketchup && npx tsc --noEmit`
Expected: No errors

**Step 3: Commit**

```bash
git add src/components/drawing-canvas.ts
git commit -m "feat(zoom): update selection preview to use drawImage for zoom support"
```

---

### Task 4: Wire Ctrl+wheel zoom input

**Files:**
- Modify: `src/components/drawing-canvas.ts:555-563` (`_onWheel`)

**Step 1: Replace `_onWheel` handler**

Replace the existing `_onWheel` method:

```typescript
private _onWheel = (e: WheelEvent) => {
  if (e.ctrlKey || e.metaKey) {
    // Zoom anchored to cursor position
    e.preventDefault();
    const rect = this.mainCanvas.getBoundingClientRect();
    const viewportX = e.clientX - rect.left;
    const viewportY = e.clientY - rect.top;

    // Document point under cursor before zoom
    const docX = (viewportX - this._panX) / this._zoom;
    const docY = (viewportY - this._panY) / this._zoom;

    // Apply zoom
    const direction = e.deltaY < 0 ? 1 : -1;
    const newZoom = Math.min(
      DrawingCanvas.MAX_ZOOM,
      Math.max(
        DrawingCanvas.MIN_ZOOM,
        this._zoom * Math.pow(DrawingCanvas.ZOOM_STEP, direction),
      ),
    );
    if (newZoom === this._zoom) return;

    // Adjust pan so the document point stays under cursor
    this._panX = viewportX - docX * newZoom;
    this._panY = viewportY - docY * newZoom;
    this._zoom = newZoom;

    this.composite();
    if (this._selection) this._redrawSelectionPreview();
    this._dispatchZoomChange();
    return;
  }

  // Plain wheel → pan
  e.preventDefault();
  this._panX -= e.deltaX;
  this._panY -= e.deltaY;
  this.composite();
  if (this._selection) this._redrawSelectionPreview();
};
```

**Step 2: Add zoom change event dispatcher**

Add after `_onWheel`:

```typescript
private _dispatchZoomChange() {
  this.dispatchEvent(new CustomEvent('zoom-change', {
    bubbles: true,
    composed: true,
    detail: { zoom: this._zoom },
  }));
}
```

**Step 3: Add public zoom accessors for keyboard shortcuts**

Add public methods for external zoom control:

```typescript
/** Zoom in by one step, anchored to viewport center */
public zoomIn() {
  this._zoomToCenter(this._zoom * DrawingCanvas.ZOOM_STEP);
}

/** Zoom out by one step, anchored to viewport center */
public zoomOut() {
  this._zoomToCenter(this._zoom / DrawingCanvas.ZOOM_STEP);
}

/** Fit document in viewport */
public zoomToFit() {
  const fitZoom = Math.min(
    this._vw / this._docWidth,
    this._vh / this._docHeight,
  ) * 0.9;
  this._zoom = Math.min(DrawingCanvas.MAX_ZOOM, Math.max(DrawingCanvas.MIN_ZOOM, fitZoom));
  this._panX = Math.round((this._vw - this._docWidth * this._zoom) / 2);
  this._panY = Math.round((this._vh - this._docHeight * this._zoom) / 2);
  this.composite();
  if (this._selection) this._redrawSelectionPreview();
  this._dispatchZoomChange();
}

/** Get current zoom level */
public getZoom(): number { return this._zoom; }

private _zoomToCenter(newZoom: number) {
  const clamped = Math.min(DrawingCanvas.MAX_ZOOM, Math.max(DrawingCanvas.MIN_ZOOM, newZoom));
  if (clamped === this._zoom) return;

  // Anchor to viewport center
  const cx = this._vw / 2;
  const cy = this._vh / 2;
  const docX = (cx - this._panX) / this._zoom;
  const docY = (cy - this._panY) / this._zoom;

  this._panX = cx - docX * clamped;
  this._panY = cy - docY * clamped;
  this._zoom = clamped;

  this.composite();
  if (this._selection) this._redrawSelectionPreview();
  this._dispatchZoomChange();
}
```

**Step 4: Update `centerDocument` to account for zoom**

Replace `centerDocument()`:

```typescript
/** Center the document in the viewport */
public centerDocument() {
  if (!this.mainCanvas) return;
  this._panX = Math.round((this._vw - this._docWidth * this._zoom) / 2);
  this._panY = Math.round((this._vh - this._docHeight * this._zoom) / 2);
  this.composite();
  if (this._selection) this._redrawSelectionPreview();
}
```

**Step 5: Update `firstUpdated` initial centering to account for zoom**

Replace lines 192-194 in `firstUpdated`:

```typescript
// Center document in viewport
this._panX = Math.round((vw - this._docWidth * this._zoom) / 2);
this._panY = Math.round((vh - this._docHeight * this._zoom) / 2);
```

**Step 6: Update `_resizeToFit` centering math**

In `_resizeToFit`, replace lines 237-239:

```typescript
// Adjust pan to keep the center stable
const oldCenterDocX = (oldWidth / 2 - this._panX) / this._zoom;
const oldCenterDocY = (oldHeight / 2 - this._panY) / this._zoom;
this._panX = newWidth / 2 - oldCenterDocX * this._zoom;
this._panY = newHeight / 2 - oldCenterDocY * this._zoom;
```

**Step 7: Verify build**

Run: `cd /Users/egecan/Code/ketchup && npx tsc --noEmit`
Expected: No errors

**Step 8: Commit**

```bash
git add src/components/drawing-canvas.ts
git commit -m "feat(zoom): wire ctrl+wheel zoom and public zoom API"
```

---

### Task 5: Add keyboard shortcuts in drawing-app.ts

**Files:**
- Modify: `src/components/drawing-app.ts:563-592` (`_onKeyDown`)

**Step 1: Add zoom keyboard shortcuts**

In `_onKeyDown`, before the closing `};`, add these cases:

```typescript
} else if (ctrl && (e.key === '=' || e.key === '+')) {
  e.preventDefault();
  this.canvas?.zoomIn();
} else if (ctrl && e.key === '-') {
  e.preventDefault();
  this.canvas?.zoomOut();
```

Also update the existing `Ctrl+0` handler (line 588-590) to use `zoomToFit` instead of `centerDocument`:

```typescript
} else if (e.key === '0' && ctrl) {
  e.preventDefault();
  this.canvas?.zoomToFit();
```

**Step 2: Verify build**

Run: `cd /Users/egecan/Code/ketchup && npx tsc --noEmit`
Expected: No errors

**Step 3: Commit**

```bash
git add src/components/drawing-app.ts
git commit -m "feat(zoom): add Ctrl+=/- and Ctrl+0 keyboard shortcuts"
```

---

### Task 6: Manual smoke test

**Steps:**
1. Run `npm run dev`
2. Open in browser
3. Verify: Ctrl+scroll wheel zooms in/out anchored to cursor
4. Verify: Pinch gesture on trackpad zooms (same as Ctrl+wheel)
5. Verify: Plain scroll wheel still pans
6. Verify: Drawing tools (pencil, shapes, fill, eraser) work correctly at different zoom levels — strokes land where the cursor is
7. Verify: Shape preview while dragging aligns with cursor at all zoom levels
8. Verify: Selection tool works — marching ants display correctly, lifted content renders at correct position
9. Verify: Ctrl+= zooms in, Ctrl+- zooms out, Ctrl+0 fits to viewport
10. Verify: Hand tool / middle-click pan works at zoomed levels
11. Verify: Resizing the browser window keeps the view stable
12. Run `npm run build` to confirm production build passes
